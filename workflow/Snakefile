import os
import json

# ‚úÖ Get the absolute path of the workflow directory
WORKFLOW_DIR = os.path.abspath(os.path.dirname(__file__))

# ‚úÖ Get the absolute path of the GitHub repository (codebase)
CODEBASE_DIR = os.path.abspath(os.path.join(WORKFLOW_DIR, ".."))

# ‚úÖ Stop execution if Snakemake is running inside Conda's `site-packages`
if "site-packages" in WORKFLOW_DIR:
    print("‚ùå ERROR: Snakemake is running inside Conda's site-packages instead of your GitHub repository!")
    print(f"‚û°Ô∏è  Please navigate to {CODEBASE_DIR} and run Snakemake again.")
    exit(1)

# ‚úÖ Get the correct path to `setup_project.py` inside your GitHub repo
SETUP_SCRIPT = os.path.join(CODEBASE_DIR, "scripts", "setup_project.py")

# üîπ Ask the user for the external project folder where data will be stored
PROJECT_FOLDER = input("üìÇ Enter the full path of your project folder (e.g., /Users/yourname/my_project): ").strip()

# ‚úÖ Ensure the project folder exists
if not os.path.exists(PROJECT_FOLDER):
    os.makedirs(PROJECT_FOLDER, exist_ok=True)

# ‚úÖ Define the correct path for `config.json` inside the separate project folder
CONFIG_FILE = os.path.join(PROJECT_FOLDER, "config.json")

# üîç Print debug information
print(f"üü¢ DEBUG INFO:")
print(f"  - Workflow directory: {WORKFLOW_DIR}")
print(f"  - Codebase (GitHub Repo) directory: {CODEBASE_DIR}")
print(f"  - Setup script path: {SETUP_SCRIPT}")
print(f"  - Project folder for data: {PROJECT_FOLDER}")
print(f"  - Config file path: {CONFIG_FILE}")

# ‚úÖ Snakemake Rule: Ensure `config.json` is created inside the external project folder
rule setup_project:
    output: CONFIG_FILE
    shell:
        "cd {CODEBASE_DIR} && python scripts/setup_project.py --project_folder {PROJECT_FOLDER}"  # ‚úÖ Ensures it runs in the correct directory

rule all:
    input:
        CONFIG_FILE,
        os.path.join(PROJECT_FOLDER, "results/processed_images.txt")  # ‚úÖ Prevents Snakemake from deleting the project folder

include: "rules/preprocess.smk"
include: "rules/postprocess.smk"